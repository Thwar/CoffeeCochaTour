@page
@using Models
@model IndexModel


@{
    ViewData["Title"] = "Home page";
    //https://docs.microsoft.com/en-us/aspnet/core/tutorials/razor-pages/model
}

<script>

    var map, popup, Popup;

    $(document).ready(function () {

        //Create Google Maps PopUp
        definePopupClass();

        //-17.376499,-66.1583852
         map = new google.maps.Map(document.getElementById('map'), {
            center: {lat: -17.376499, lng: -66.1583852},
            zoom: 14,
            gestureHandling: 'greedy'

        });

        var infoWindow = new google.maps.InfoWindow();
        var service = new google.maps.places.PlacesService(map);

        // Try HTML5 geolocation.
        //if (navigator.geolocation) {
        //    navigator.geolocation.getCurrentPosition(function(position) {
        //        var pos = {
        //            lat: position.coords.latitude,
        //            lng: position.coords.longitude
        //        };

        //        infoWindow.setPosition(pos);
        //        infoWindow.setContent('Location found.');
        //        console.log('Location found.');
        //        infoWindow.open(map);
        //        map.setCenter(pos);
        //    }, function() {
        //        handleLocationError(true, infoWindow, map.getCenter());
        //    });
        //} else {
        //    // Browser doesn't support Geolocation
        //    handleLocationError(false, infoWindow, map.getCenter());
        //}




        //LOOP COFFFFEEEESSSS
        var shops = @Html.Raw(Json.Serialize(@Model.CoffeeShop));

        for (var i = 0; i < shops.length; i++) {
            loopCoffees(i, service,infoWindow );
        }

    });

    function loopCoffees(i, service, infoWindow) {
        setTimeout(function() {

            var shops = @Html.Raw(Json.Serialize(@Model.CoffeeShop));

              console.log(shops);
              var id = shops[i].googlePlaceId;
              console.log(id);

            service.getDetails({
                placeId:shops[i].googlePlaceId
            }, function(place, status) {

                console.log(place  + ' ' + status);
              //  if (status === google.maps.places.PlacesServiceStatus.OK) {

                    //Create Marker
                    //var marker = new google.maps.Marker({
                    //    map: map,
                    //    position: place.geometry.location
                    //});
                    //END

                    //cREATE POPUP
                    var lat = place.geometry.location.lat();
                    var lng = place.geometry.location.lng();


                    var mapPopup = document.createElement("P");       // Create a <p> node
                    var t = document.createTextNode(place.name);      // Create a text node
                    mapPopup.appendChild(t);


                    popup = new Popup( new google.maps.LatLng(lat, lng), mapPopup);
                    popup.setMap(map);


                    google.maps.event.addDomListener(mapPopup, 'click', function() {
                       // window.alert(place.name + 'Map was clicked!');


                        var marker = new google.maps.Marker({
                            position: {lat:  place.geometry.location.lat(), lng: place.geometry.location.lng()},
                            map: map
                        });


                        //Get DB Place
                       var shop =  shops.find(isPlaceId);
                        function isPlaceId(shop) {
                            return shop.googlePlaceId === place.place_id;
                        }

                        //Map popup HTML
                        infoWindow.setContent(" <div>"+
                            "<div class='col-xs-6'> <img class='mapImg' src='" + shop.image1Url + "' /></div>" +
                            "<div style='text-align: center' class='col-xs-6'><strong>" + place.name + '</strong><br><br>'+
                            '  <a href="/CoffeeShops/Details/'+ shop.name +'">Abrir Pagina</a>' +
                            ' </div>' +
                         //   'Place ID: ' + place.place_id + '<br>' +


                          //  place.formatted_address +
                            '</div>');


                        infoWindow.setZIndex(5000);

                        infoWindow.open(map, marker);
                    });


                    //google.maps.event.addListener(popup, 'click', function() {
                    //    infoWindow.setContent('<div><strong>' + place.name + '</strong><br>' +
                    //                          'Place ID: ' + place.place_id + '<br>' +
                    //                             place.formatted_address + '</div>');
                    //    infoWindow.open(map, this);
                    //});
             //   }
            });

         }, 200 * i);
    }

</script>


<style>
    #map {
        display: block;
        width: 100%;
        height: 350px;
    }

    #map {
        background: #58B;
    }

    .gm-style-iw {
        width: 300px !important;
    }
</style>

<div id="map"></div>


@*<div id="myCarousel" class="carousel slide" data-ride="carousel" data-interval="6000">
        <ol class="carousel-indicators">
            <li data-target="#myCarousel" data-slide-to="0" class="active"></li>
            <li data-target="#myCarousel" data-slide-to="1"></li>
            <li data-target="#myCarousel" data-slide-to="2"></li>
            <li data-target="#myCarousel" data-slide-to="3"></li>
        </ol>
        <div class="carousel-inner" role="listbox">
            <div class="item active">
                <img src="~/images/banner1.svg" alt="ASP.NET" class="img-responsive" />
                <div class="carousel-caption" role="option">
                    <p>
                        Learn how to build ASP.NET apps that can run anywhere.
                        <a class="btn btn-default" href="https://go.microsoft.com/fwlink/?LinkID=525028&clcid=0x409">
                            Learn More
                        </a>
                    </p>
                </div>
            </div>
            <div class="item">
                <img src="~/images/banner2.svg" alt="Visual Studio" class="img-responsive" />
                <div class="carousel-caption" role="option">
                    <p>
                        There are powerful new features in Visual Studio for building modern web apps.
                        <a class="btn btn-default" href="https://go.microsoft.com/fwlink/?LinkID=525030&clcid=0x409">
                            Learn More
                        </a>
                    </p>
                </div>
            </div>
            <div class="item">
                <img src="~/images/banner3.svg" alt="Package Management" class="img-responsive" />
                <div class="carousel-caption" role="option">
                    <p>
                        Bring in libraries from NuGet and npm, and automate tasks using Grunt or Gulp.
                        <a class="btn btn-default" href="https://go.microsoft.com/fwlink/?LinkID=525029&clcid=0x409">
                            Learn More
                        </a>
                    </p>
                </div>
            </div>
            <div class="item">
                <img src="~/images/banner4.svg" alt="Microsoft Azure" class="img-responsive" />
                <div class="carousel-caption" role="option">
                    <p>
                        Learn how Microsoft's Azure cloud platform allows you to build, deploy, and scale web apps.
                        <a class="btn btn-default" href="https://go.microsoft.com/fwlink/?LinkID=525027&clcid=0x409">
                            Learn More
                        </a>
                    </p>
                </div>
            </div>
        </div>
        <a class="left carousel-control" href="#myCarousel" role="button" data-slide="prev">
            <span class="glyphicon glyphicon-chevron-left" aria-hidden="true"></span>
            <span class="sr-only">Previous</span>
        </a>
        <a class="right carousel-control" href="#myCarousel" role="button" data-slide="next">
            <span class="glyphicon glyphicon-chevron-right" aria-hidden="true"></span>
            <span class="sr-only">Next</span>
        </a>
    </div>*@


<div class="row" style="text-align: center">

    @foreach (var item in Model.CoffeeShop)
    {
        <div class="col-sm-4 col-xs-12">

            <figure class="snip1440 ">

                @if (item.Image1Url != null)
                {
                    <img src="@Html.DisplayFor(modelItem => item.Image1Url)" alt="sample66" />
                }
                else
                {
                    <img src="images/missing.png" alt="sample66" />
                }

                <figcaption>
                    <h3>@Html.DisplayFor(modelItem => item.Name)</h3><span> </span>
                </figcaption>
                <a href="/CoffeeShops/Details/@item.Name"></a>
            </figure>

        </div>

    }

</div>

